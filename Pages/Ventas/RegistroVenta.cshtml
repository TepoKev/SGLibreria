@page
@model Ventas.RegistroVentaModel

@{
ViewData["Title"] = "Registro Venta";
}

<style>
  body {
    color: #555;
  }

  #nav-inferior .btn-dark:hover {
    background-color: #1597a8 !important;
  }

  #productos-seleccionados {
    right: 0;
    position: absolute;
    transition: max-width .4s;
  }

  #productos-seleccionados:hover {}
</style>
<div class="row" style='margin-top:15px;'>
  <form id='formToken' method='post'></form>
  <div id='productos' style='margin-top:15px;margin-bottom:100px;'>
  </div><!-- #productos -->
  <!--columna de productos y servicios -->
  <div class="col-lg-3  bg-white" id="productos-seleccionados" hidden="">
    <h3 class="h5 bg-primary text-white p-1 text-center">Venta a realizar</h3>
    <div id="contentItems" class="slimscroll-all" style="min-height: 300px;">
    </div>
    <div class="row alert-info alert font-weight-bold">
        <div class="col-lg-6">Total: $</div>
        <div class="col-lg-6" id="montTot"> 0</div>
    </div>
    <div class="row">
      <div class="col-lg-6">
        <div class="custom-control custom-checkbox pt-2">
          <input type="checkbox" class="custom-control-input" id="factura">
          <label class="custom-control-label" for="factura">Con factura</label>
        </div>
      </div>
      <div class="col-lg-6">
        <a class="btn btn-outline-primary" href="#"> <i class="fas fa-save"></i> Vender </a>
      </div>
    </div>
  </div>
</div>
<div id="nav-inferior" class="row bg-white position-fixed ml-4 pl-1 pt-3"
  style="bottom:0;border-top:2px solid #e5e5e5; z-index: 3;">
  <div class="col-lg-4">
    <div class="input-group mb-3">
      <input type="text" id="NombreOCodigo" class="form-control" placeholder="Nombre o cÃ³digo de producto"
        aria-describedby="button-addon2">
      <div class="input-group-append">
        <button class="btn btn-primary" type="button"><i class="fas fa-search"></i></button>
      </div>
    </div>
  </div>
  <div class="offset-1 col-lg-3">
    <nav aria-label="...">
      <ul class="pagination mb-0">
        <li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
            &lt;&lt; </a> </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item active" aria-current="page">
          <a class="page-link" href="#">2 <span class="sr-only">(current)</span></a>
        </li>
        <li class="page-item">
          <a class="page-link" href="#">3</a>
        </li>

        <li class="page-item">
          <a class="page-link" href="#">>></a>
        </li>
      </ul>
    </nav>
  </div>
  <div class="col-lg-3">
    <button class="btn btn-outline-success" id="btnVenta">
      Mostrar Lista de ventas
      <i class="fas fa-shopping-cart"></i>
    </button>
  </div>
  <div class="btn-group" id="categorias" role="group" aria-label="Basic example">
    @foreach (var Cat in Model.Categorias) {
    <button type="button" data-IdCategoria="@Cat.Id" class="btn btn-dark">@Cat.Nombre</button>
    }
    <button type="button" class="btn btn-dark"> <i class="fas fa-redo-alt"></i> </button>
  </div>
</div>
<template id="templateItem">
  <div class="form-group row">
    <label for="" class="col-sm-7 col-form-label col-form-label-sm"></label>
    <div class="col-sm-5">
      <div class="input-group">
        <input type="number" class="form-control form-control-sm" value="2" placeholder="Cantidad">
        <div class="input-group-append">
          <i class="fas fa-trash text-danger mano" data-eprod=""></i>
        </div>
      </div>
    </div>
  </div>
</template>
@section Styles{
<link href="~/selectric/src/selectric.css" rel="stylesheet">
}
@section Scripts {
<script src="~/selectric/src/jquery.selectric.js"></script>
<script src="~/js/sgl.js"></script>
<script>
  $(function () {
    $('select').selectric();
  });
</script>
<script>
  var BtnVenta = document.querySelector('#btnVenta');
  var divProductos = sgl.q('#productos');
  var divCategorias = sgl.q('#categorias');
  var NombreOCodigo = sgl.q('#NombreOCodigo');
  var doc = document;
  var prodDisponibles = doc.getElementById('productos');
  var items = [];
  sgl.get('../Productos/ListaProductoAjax', refrescar);

  function refrescar(data) {
    var divProductos = sgl.q('#productos');
    divProductos.innerHTML = data;
  }
  BtnVenta.addEventListener("click",(e)=>{
    var btn = e.currentTarget;
    var divelems = document.querySelector("#productos-seleccionados");
    if(divelems.getAttribute("hidden") == ""){
      divelems.removeAttribute("hidden");
      btn.firstChild.textContent = "Ocultar Lista de Ventas";
    }else{
      divelems.setAttribute("hidden","");
      btn.firstChild.textContent = "Mostrar Lista de Ventas";
    }
  })
  NombreOCodigo.focus();
  NombreOCodigo.oninput = function (e) {
    buscarProducto(NombreOCodigo.value);
  };

  function buscarProducto(NombreCodigo, IdCategoria) {
    params = "";
    if (NombreCodigo) {
      params += "NombreOCodigo=" + NombreCodigo;
    }
    if (IdCategoria) {
      params += "&IdCategoria=" + IdCategoria;
    }
    sgl.get('ListaProductoAjax', function (data) {
      var divProductos = sgl.q('#productos');
      divProductos.innerHTML = data;
    }, params);
  }
  //clic la imagen del card activa un elemento
  divProductos.addEventListener('click', function (evento) {
    var target = evento.target;
    if (target.matches('img')) {
      var card;
      card = target.parentNode;
      if (card.getAttribute('data-seleccionado') == 'true') {
        removeList(card);
      } else {
        addList(card);
      }
    }
  });
  divCategorias.onclick = function (evento) {
    var target = evento.target;
    var IdCategoria = target.getAttribute('data-idcategoria');
    if (IdCategoria != null) {
      buscarProducto(NombreOCodigo.value, IdCategoria);
    } else {
      buscarProducto(NombreOCodigo.value);
    }
  }
  //Esta funcion nos permitira desmarcar un elemento de la tabla, borrar un registro del array items y eliminarlo de la lista de ventas
  function removeList(card){
    var producto = {
      id: "",
      nombre: "",
      precio: 0
    };
    //En esta parte se elimina el producto del arreglo items y se desmarca
    producto.id = card.getAttribute("data-idprod");
    producto.nombre = card.getAttribute("data-nombre");
    producto.precio = card.getAttribute("data-precio");
    var idAct = producto.id;
    var pos = -1;
    var cardFooter = card.querySelector('.card-footer');
    cardFooter.classList.remove('bg-primary');
    cardFooter.classList.remove('text-white');
    cardFooter.classList.add('text-primary');
    card.setAttribute('data-seleccionado', false);
    items.forEach(({id}, indice)=>{
      if(id == idAct){
        pos = indice;
      }
    });
    if(pos > -1){
      items.splice(pos, 1);
    }
    //Ahora se eliminara de la lista basado en el data-rprod que coincide con el id del producto
    var divItems = document.querySelector("#contentItems");
    let divRel = divItems.querySelector('div[data-rprod="'+ idAct +'"]');
    divItems.removeChild(divRel);
    actMontoTot();
  }

  //Esta funcion nos permitira marcar un elemento de la tabla, agregar un registro al array items y agregarlo a la lista de ventas
  function addList(card){
    var producto = {
      id: "",
      nombre: "",
      precio: 0
    };
    producto.id = card.getAttribute("data-idprod");
    producto.nombre = card.getAttribute("data-nombre");
    producto.precio = card.getAttribute("data-precio");
    var cardFooter = card.querySelector('.card-footer');
    cardFooter.classList.add('bg-primary');
    cardFooter.classList.add('text-white');
    cardFooter.classList.remove('text-primary');
    card.setAttribute('data-seleccionado', true);
    var divItems = document.querySelector("#contentItems");
    var temp = document.querySelector("#templateItem");
    var clon = temp.content.cloneNode(true);
    let divR = clon.firstElementChild.setAttribute("data-rprod", producto.id);
    let lbl = clon.firstElementChild.firstElementChild;
    let ipt = clon.firstElementChild.lastElementChild.firstElementChild.firstElementChild;
    let ic = clon.firstElementChild.lastElementChild.firstElementChild.lastElementChild.firstElementChild;
    lbl.innerHTML = producto.nombre;
    ipt.setAttribute("id", ("p"+producto.id));
    lbl.setAttribute("for",("p"+producto.id));
    ic.setAttribute("data-eprod", producto.id);
    divItems.appendChild(clon);
    items.push(producto);
    actMontoTot();
  }

  function actMontoTot(){
    var suma = 0;
    console.log(items);
    items.forEach(({precio})=>{
      suma = suma + parseFloat(precio);
    });
    document.querySelector("#montTot").innerHTML= Number.parseFloat(suma).toFixed(2);
  }

  function buscarProducto(NombreCodigo, IdCategoria) {
    params = "";
    if (NombreCodigo) {
      params += "NombreOCodigo=" + NombreCodigo;
    }
    if (IdCategoria) {
      params += "&IdCategoria=" + IdCategoria;
    }
    sgl.get('ListaProductoAjax', function (data) {
      var divProductos = sgl.q('#productos');
      divProductos.innerHTML = data;
    }, params);
  }
</script>
}